# The Effect of Propagation Delay Due to Geo-distribution on Blockchains
(This article was submitted as a requirement for the Ninja Tier NFT badge offered by the DeFi MOOC course 2021
Https:/defi-learning.org/f21 )
.


In the last fireside chat series [1] mins 38-41Jerrmy Allaire said that the physical network delay is a big challenge for DeFi systems as decisions could be taken in nano seconds in electronic money systems, while the minimum blockchain propagation time he knows about is 360 milli seconds in Solana. Before it was mentioned in the lectures of DeFi MOOC course [2] I’ve never thought about, or passed by in a previous reading, the effect of propagation time on the mining process. There is a propagation delay in our every day use of the internet; the data have to be routed through some network path and be physically transmitted you sure know that and heard about the cables under the seas and oceans,….etc and all this stuff. Meaning a search result near your location probably will arrive faster than a search result far from your point (There are other parameters that decides the data shortest route in regular networks like the frequency of access, the common nodes, the capacity of each link,…etc but this is beyond the scope of this article); it’s only that the time difference evenif it’s in seconds in the worst case is still negligible for the ordinary user to notice. However, in blockchains the case is much way different for so many reasons; for a start, with a lot to follow, every thing is automated and the order does matter time worth money here.

**The Big Picture**
By propagation time in blockchains people usually mean the transmission time delay to the scattered all round the world destinations in a blockchain; this could be on a block level as the time to be shared by enough number of full nodes to reach consensus, or on a transaction level as the transmission time to reach mempools. Data transmission in blockchains is classified as the Network Layer, Fig1 from lecture 13, and is usually done through a Peer to Peer communication protocol. Naturally, there must be an inherent propagation delay in any newtork, I do not want to get into the data communication details (I’m more interested in its consequences on transactions and blocks and hence the DeFi process. So, as simple as possible this means the nodes are best visualized as nodes in a graph where edge value represents in our case the time needed to transmit the target info (transaction or block) between those two nodes. Each cryptocurrency uses different protocols according to its main characteristics, protocols differ mainly in the Algorithm (strategy) they deploy to make packets (transmitted info) reach most nodes; and they all usually involve some redundancy sending to fasten the process.
This article tries to explore the effect of propagation delay in blockchains (even in the absence of an adversary) and improvements provided by newer protocols to mitigate such effect. While we may first think this would be a problem only for just faster blockchains like Ethereum (a block in every 10 seconds) [3,4], it turns out to be a problem even with slower block generation rate ones like Bitcoin (a block every 10 mins too) [5,6]. We will dive into the details of both blockchains as we go on.





Fig1 Blockchain layers

**First Thoughts**
The first thought that crossed my mind is the possibility of geographical clustering of transactions in blocks, and the neighborhood/near favoring in transaction ordering. If we took the example from the lecture of the propagation time between North America and Australia for two transactions with exactly the same fee, clearly the pools from each countery will see its transaction first with the following possible consequences:
1-If we execlude miner bribing, each transaction will appear first in blocks generated by its nearer pool, even without any adversaries since mempools apply FIFO when fees are equal; Fig.2.

»One may think of attaching a timestamp cryptographically signed by the first full node or Mempool that receives a transaction, but more research is needed to know whether this is applicable (feasible regarding protocols constraints) or not, or maybe if this is already done.



Fig.2: How the propagation delay will affect the order of the three transactions A,B,C if it is t1 between A&B and t2 between B&C, assuming t1 < t2 , which block will be selected? note that the selection probability may still be affected by block propagation time from its mempool to enough full nodes to reach consensus (depends on the distribution of full nodes arround the globe), along with the more dominant effect hashing power ofcourse.

2-Especially in faster blockchains like Ethereum, a transaction has a higher probability of appearing in blocks minted by its neighboring pools. This what I described as a goegraphical clustering.
3-Also, one may think of possible detection of the geographical location of a user based on propagation time of his/her transactions in different pools; the idea of adding a timestamp would contribute more to this.

The World Power or Wealth Distribution
Let me elaborate on this point further; [7] reported the dominance of 4 mining pools to about 60-70% of Bitcoin and Ethereum mining power (2020), also mentioned [8] results that less than 10 mempools constitutes about 80% of Ethereum mining power (2017), and [9] that 75% of Bitcoin mining power resides in 2% of its full nodes (2015). For exact online statistics check https://miningpoolstats.stream where you can see how the last 100(0) blocks are divided between pools; today 10/1/2022 for example in Bitcoin the first 3 pools made 49% (17+12+20), 6 pools made 84% (+10+11+14) of the last 100 blocks with USA dominating with 41% (17+10+14). In Ethereum the first 3 pools made 56% out of 1000 blocks (328+140+92), 6 pools made 75.9% (99+52+48) I don’t know pools locations except USA 9.2%, and Ethermine with 32.8% is in West Europe from [7] . The f2pool which is said to be geographically distributed ( again one will have to check how exactly) is the 3rd in Bitcoin with 20% of the blocks, the 2nd in Ethereum with 14%.

From another perspective, you can recall a question in each fireside chat about the so called “Whales” transactions constituting the majority. This is true and normally expected in a POW system; the more money you have the more you can buy hashing power, and also miners may refer to join larger mining pools to have a better chance of being included, and more other factors like larger transaction fees reaching 50-200$ in Ethereum L1 [10],…etc. However, what I had in mind is the impact of the propagation delay or any intermediary steps that a miner, or a user from a far away countrey with less number of mining pools or full nodes; for example as a miner with certain hash power is it a better chance for you to join a higher hash power pool that is far away, or a one nearer with less hash power, remember that a nearer pool may suffer a propagation delay for its block too?
-The authors of [7] do mention it in that “the emergence of huge mining pools does not only centralize mining power on a few entities, but also on a few geographical hotspots“. Check out their bar results in Fig. 3 a&b, about Ethereum 2020, the distribution is not any near to equiprobable. They used 4 scattered modified full nodes as an observation points; North America, NE, East Europe, EE, West Europe, WE, and West Asia, WE as shown in the figures., A first question in my mind is this good enough to get the complete picture, or should have they included Australia and/or Far east?


![FB_IMG_1653567685932](https://user-images.githubusercontent.com/83260375/187928224-7b1282d2-0e8b-4d76-986d-3a349fa0cfeb.jpg)

Fig.3 ratios of 1st block observation, results from [7]

Then back to my theoritical questions again, how should we put the impact of propagation delay in equations to calculate the higher probability for a block to be included???Should we put it also in our calculations for the needed Hash power ratio to perform a certain attack too???
Ofcourse these are not all the effects, at least we know from the course about its possible impact on certain, but this what crossed my mind at the beginning and incentivised me to search for more and start a deep dive on the topic. As mentioned earlier I first searched for Ethereum since the delay ratio will be more significant with faster block intervals, but surprisingly enough I found research papers and discussions on both Ethereum and Bitcoin. So I’ll try to summarize what I found in this article first on Ethereum then on Bitcoin.

**Ethereum**

The Ethereum network disseminates transactions and blocks using a gossip-based protocol [7], where data are sent randomly and repeatedly to neighboring nodes, the neighborhood here is independent from geographical location and is established randomly among peers by the protocol. In 3/2021 [12] measured the average degree of Ethereum nodes to be 47 with a few super nodes with degree greater than 1000, they measured an average of ~ 3.7 hops needed for the broadcast of a transaction or a block from one Ethereum node to the whole Blockchain. The most newer result I found is in 11/2021 from bloXroute Labs in Singapore [4] where they announced reaching 0.172 sec block propagation delay instead of 0.36 sec by using a layer 0 approach to send pointers to the transactions in mempools instead of transmitting the transactions themselves; unfortunately, I couldn’t find more clarifying details even in their Lab link. However, one might think of adopting a similar approach for transactions and send only the size and the fee ( in a commit then reveal style somehow); then when the Mempool adjust the transaction arrival time, it can fetch the contents.

Propagation Delay on Ethereum As early as 2015 people started discussing in Reddit [3] the effect of propagation delay on blocks; the larger the time gap between nodes receiving blocks the more forks and wasted hash power in the network, since miners will not be aware of each other’s blocks in time and lagging nodes (if delayed by more than the block interval which is 10 secs in Ethereum) may put a much newer block on top of a much older block. Although a comment on stack-exchange 2019 [13] roughly estimated using observation of ethstat.net that most nodes will know within about 15 seconds of inclusion in a block, Vitalik Buterin in 2015 [3] estimated the block propagation delay to have a mean ~ 3 seconds from the uncle block statitstics (Ethereum rewards recognized forks as uncle blocks, this was intentionally meant to help less powerful miners from losing their work due to delays or less hash power; [7] reported a ratio of 6.97% uncle blocks of which 11% were produced simultaneously by the same selected block miner and thus they suspect they are deliberately mined to get the uncle reward and has nothing to do with the propagation delay. This, execluding those presumably deliberate 11%, downs the ratio to 6.2% which is roughly similar to current ethstats.net values.

The ratio of forks and uncle blocks are not the only results from [7], the paper observed what could lead to some kind of monopoly and double spending attacks; the number of consecutive blocks produced by the same pool. Like the 6-block escrow time in Bitcoin where the probability becomes small enough, this threshold in Ethereum is 12 blocks; if one mining pool was able to produce 12 blocks in a row, it can censor the blockchain, perform double spending attacks, and also increase the latency for some transactions. Their observations found a max of 14 blocks in sequence, and strange enough 9 blocks in row found twice in a month by Spark pool, which is much different than expected from its hash power (0.226⁹ × 201,086=~0.3); the authors guess it’s due to too optimistic measures in considering a block final; however for me I think the geo location of available transactions and full nodes active at that time may have contributed to these two incidents (Spark pool was located in China with hashrate ~ 23.5%, where massive mining was done before it was banned[14]). In addition, I recall the specific mentioning of Spark pool in some MEV attacks reported in the literature [15]; unlike [7], the authors of [15] suspected Spark pool intentions as trying to conceal its privately mined transactions with fitting gas prices and seemingly random block order, and issuing its privately mined transactions exclusively to a smart contract which is apparently performing arbitrage. Anyways, it is completely closed now.

The authors of [7] measured also the ratio of empty blocks to be 1.45% (2,921 out of 201,086 total blocks during the month of their experiment), they noticed 25% of blocks mined by the Zhizu pool were empty and all the 6 blocks minted by a single miner to be empty. Infact the talking about empty blocks raised my doubts about the timing of the paper (2020) being before the deployment of EIP-1559 and whether the results are still representing the reality, but the statistics coming from public sites are still very much near what they have measured (except I don’t see empty blocks, the least block I noticed containing 12 TXs).

As for transactions propagation delay, the authors measured the ratio of transactions received out of order to be 11.54% and reported an increase from 6.2% measured in 2017 by [8] . They say they didn’t observe any significant latency in committing transaction that they omitted the results from the paper due to space constraints; however, they did not measure the effect on transaction ordering. What I discussed above in Fig.2 is the possibility of geo-frontrunning, it could be that transactions A,B,C get commited within average latency but in a geo-favoring order.

Propagation Delay on Bitcoin

To be added summarizing references [5,6,16-20]. The main observation is that most papers perform simulation models following an old 2013 paper [17] that measured the median time for a node to receive a block was 6.5 secs, the mean was 12.6 secs and that 95% of the distribution was around 40 sec. They showed that an exponential distribution provided a reasonable fit to the propagation delay distribution; infact the Ethereum block propagation time in ethstats.net is pretty much similar to that too. In [18], 11/2020, the dissemination latency is modelled with a lognormal distribution, with its parameters estimated using a Bayesian model that can be updated dynamically. I found even a paper, 3/2017, numerically analalyzing the Bitcoin network using a Susceptible/Exposed/Infective/Recovered (SEIR) epidemic model with seasonal transmission, here’s the link [19] for the interested reader, but sorry I’m not going to get into that!

-It also attracted my attention that [18] mentioned through the text that the minimum connection number used by the default Bitcoin client is 8, as opposed to 3.7-6 as measured by [12] in Ethereum. Anyways, I said this article is not mainly concerned about the technical communication details, here’s the official Bitcoin site info [20] for the interested reader.

-Before ending the article, let me add a piece of info that made things kind of more clear for me; from an updated answer by G Maxwell here [21], “Fiber first sends a short block sketch: A list of short hashes and lengths that allow the far end to use its mempool to lay out transactions into a block, with holes in positions where the transactions were missing or the hash was ambiguous”. So, it seems that the newer Ethereum protocol from Singapore [4], and my hypothetical suggestion of sending like a little TX header to the pool, is somewhat how Bitcoin Fibre[6] works from 2017; I guess the main difference I noticed from this fast reading is that there is an error correction part here that is needed here and we don’t know if [4] works in the same manner.

-I can just conclude for now that the stream statitstics I showed earlier is enough evidence for me on the geo clustering of Bitcoin blocks, and hence order favoring, in its origin, USA, especially after the China and some other countries banning mining. One could except another geographical clusters will be formed with newer countries adopting Bitcoin as their official currency, however maybe this is not showing now in because the current ones, Venzuela and El Silvador, are all geographically near USA.

**References**

[1] DeFi MOOC 2021, https://defi-learning.org/, lectures &13.1

[2] DeFi MOOC 2021, fireside chat 3, Jeremy Allaire, Founder and CEO of Circle, https://youtu.be/xQ62PCRm1Zg, mins 38-41.

[3]https://www.reddit.com/r/ethereum/comments/369drd/block_propagation_time_is_not_proper_on_ethereum/, last accessed 8/1/2022 but post from 2015

[4]https://www.bcbitcoin.co.uk/articles/ethereum-block-propagation-time-cut-in-half-thanks-to-scaling-fix/, last accessed 2/1/2022

[5]https://bitcoin.stackexchange.com/questions/98875/how-does-block-propagation-delay-not-cause-accidental-forks

[6] The Bitcoin Fibre protocol, https://bitcoinfibre.org

[7] Paulo Silva, David Vavriˇ cka, Jo ˇ ao Barreto and Miguel Matos, “Impact of Geo-distribution and Mining Pools on Blockchains: A Study of Ethereum”, 50th IEEE/IFIP International Conference on Dependable Systems and Networks (DSN), 2020.
[8] L. Luu, Y. Velner, J. Teutsch, and P. Saxena, “Smart pool: Practical decentralized pooled mining.” IACR Cryptology ePrint Archive, vol.2017, p. 19, 2017
[9] A. Miller, J. Litton, A. Pachulski, N. Gupta, D. Levin, N. Spring, and B. Bhattacharjee, “Discovering bitcoins public topology and influential nodes,” May 2015, accessed: 2020-03-10. [Online]. Available:http://cs.umd.edu/projects/coinscope/coinscope.pdf

[10]DeFi MOOC 2021, fireside chat 1, Micheal Egorov founder of Curve Finance, https://youtu.be/bNn0kCU7mrY, mins 25-27.

[11] MAS.S26, “Cryptocurrency Engineering and Design”, MIT open courseware, Electrical Engineering Dept, Spring 2018, https://ocw.mit.edu/courses/media-arts-and-sciences/mas-s62-cryptocurrency-engineering-and-design-spring-2018/

[12]T. Wang, C. Zhao, Q. Yang, S. Zhang, and S.C. Liew, “Ethna: Analyzing the Underlying Peer-to-Peer Network of Ethereum Blockchain”, arXiv:2010.01373v2 [cs.NI] 27 Mar 2021.

[13]https://ethereum.stackexchange.com/questions/60504/ethereum-propagation-delay, last accessed 8/1/2022, but last comment in post 6/6/2019.

[14] https://forkast.news/headlines/spark-pool-allows-balance-withdrawal-as-it-phases-out-all-domestic-international-users/

[15] Kaihua Qin, Liyi Zhou, and Arthur Gervais, “Quantifying Blockchain Extractable Value: How dark is the forest?”, arXiv:2101.05511v3 [cs.CR] 22 Jan 2021.

[16] Mostafa BA, “The effect of propagation delay on the dynamic evolution of the Bitcoin blockchain”, Digital Communications and Networks Vol 6, Issue 2, May 2020, Pages 157-166, https://doi.org/10.1016/j.dcan.2019.01.006

[17] C. Decker, R. Wattenhofer, “Information propagation in the bitcoin network”, 13th IEEE International Conference on Peer-to-Peer Computing (P2P), Trento, Italy (2013)

[18] David Mödinger, Jan-Hendrik Lorenz, and Franz J. Hauck, “Unobtrusive monitoring: Statistical dissemination latency estimation in Bitcoin’s peer-to-peer network”, doi: 10.1371/journal.pone.0243475.r003, published online Dec 2020.

[19] Craig S. Wright, “Bitcoin SEIR-C Propagation Models for Block and Transaction Dissemination”, https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3151940, SSRN, Elsevier, written 3/2017, posted 4/2018.

[20] https://en.bitcoin.it/wiki/Network

[21] https://bitcoin.stackexchange.com/questions/56485/can-someone-please-explain-fibre-to-me-like-im-5-and-why-is-it-useful, G. Maxwell answer, last accessed 11/1/2022.


